# WebSocket Protocol (v1)

This document defines the versioned Mage Knight WebSocket contract used between clients and `@mage-knight/server`.

## Versioning

- Current version: `1.0.0`
- Every wire message must include `protocolVersion`.
- Server runtime validation rejects unsupported versions with an `error` message and `errorCode: "unsupported_version"`.

## Source of Truth

- Type and validation source: `packages/shared/src/networkProtocol.ts`
- Generated JSON schemas:
  - `packages/shared/schemas/network-protocol/v1/client-to-server.schema.json`
  - `packages/shared/schemas/network-protocol/v1/server-to-client.schema.json`

Schemas are generated by:

```bash
bun run --filter @mage-knight/shared generate:network-schemas
```

## Client -> Server Messages

### `action`

```json
{
  "protocolVersion": "1.0.0",
  "type": "action",
  "action": {
    "type": "end_turn"
  }
}
```

### `lobby_subscribe`

Defined for lobby/session phase clients.

```json
{
  "protocolVersion": "1.0.0",
  "type": "lobby_subscribe",
  "gameId": "g_1234567890",
  "playerId": "player-1",
  "sessionToken": "optional-session-token"
}
```

## Server -> Client Messages

### `state_update`

```json
{
  "protocolVersion": "1.0.0",
  "type": "state_update",
  "events": [],
  "state": {}
}
```

### `error`

```json
{
  "protocolVersion": "1.0.0",
  "type": "error",
  "message": "Invalid action message",
  "errorCode": "invalid_payload"
}
```

### `lobby_state`

Defined for lobby/session phase updates.

```json
{
  "protocolVersion": "1.0.0",
  "type": "lobby_state",
  "gameId": "g_1234567890",
  "status": "lobby",
  "playerIds": ["player-1", "player-2"],
  "maxPlayers": 2
}
```

## External Client Guidance

- Validate `protocolVersion` and `type` before processing payload fields.
- Treat unknown `type` values as non-fatal protocol errors.
- Prefer generated schemas for language-agnostic validation codegen (for example Python clients).
