# WebSocket Protocol (v1)

This document defines the versioned Mage Knight WebSocket contract used between clients and `@mage-knight/server`.

## Current Validation Scope (v1)

The current v1 runtime parser and JSON Schemas intentionally validate the wire envelope and top-level shape only:

- `protocolVersion`
- `type`
- required top-level fields per message type

Payload fields are currently shallow-validated:

- `action` is only checked for a top-level `action.type` string
- `events[]` is only checked as an array
- `state` is only checked as an object

The deep payload contracts still come from shared TypeScript source types in `@mage-knight/shared`:

- `PlayerAction`
- `GameEvent`
- `ClientGameState`

## Versioning

- Current version: `1.0.0`
- Every wire message must include `protocolVersion`.
- Server runtime validation rejects unsupported versions with an `error` message and `errorCode: "unsupported_version"`.

## Source of Truth

- Type and validation source: `packages/shared/src/networkProtocol.ts`
- Generated JSON schemas:
  - `packages/shared/schemas/network-protocol/v1/client-to-server.schema.json`
  - `packages/shared/schemas/network-protocol/v1/server-to-client.schema.json`

Schemas are generated by:

```bash
bun run --filter @mage-knight/shared generate:network-schemas
```

## Client -> Server Messages

### `action`

```json
{
  "protocolVersion": "1.0.0",
  "type": "action",
  "action": {
    "type": "end_turn"
  }
}
```

### `lobby_subscribe`

Defined for lobby/session phase clients.

```json
{
  "protocolVersion": "1.0.0",
  "type": "lobby_subscribe",
  "gameId": "g_1234567890",
  "playerId": "player-1",
  "sessionToken": "optional-session-token"
}
```

## Server -> Client Messages

### `state_update`

```json
{
  "protocolVersion": "1.0.0",
  "type": "state_update",
  "events": [],
  "state": {}
}
```

### `error`

```json
{
  "protocolVersion": "1.0.0",
  "type": "error",
  "message": "Invalid action message",
  "errorCode": "invalid_payload"
}
```

### `lobby_state`

Defined for lobby/session phase updates.

```json
{
  "protocolVersion": "1.0.0",
  "type": "lobby_state",
  "gameId": "g_1234567890",
  "status": "lobby",
  "playerIds": ["player-1", "player-2"],
  "maxPlayers": 2
}
```

## External Client Guidance

- Validate `protocolVersion` and `type` before processing payload fields.
- Treat unknown `type` values as non-fatal protocol errors.
- Prefer generated schemas for language-agnostic validation codegen (for example Python clients).

## Known Limitations

- v1 does not yet provide deep JSON Schema validation for `PlayerAction`, `GameEvent`, or `ClientGameState`.
- Envelope/schema compatibility checks are strong, but payload semantic validation is still performed by server game logic after envelope parsing.
- Follow-up work should add deeper payload schemas so external SDKs can validate full message semantics pre-runtime.
