name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  actions: read
  checks: write
  pull-requests: write

jobs:
  build:
    name: Build & Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
            packages/*/node_modules
          key: bun-${{ runner.os }}-${{ hashFiles('bun.lock') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Install dependencies
        run: bun install

      - name: Build
        run: bun run build

      - name: Lint
        run: bun run lint

  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
            packages/*/node_modules
          key: bun-${{ runner.os }}-${{ hashFiles('bun.lock') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Install dependencies
        run: bun install

      - name: Build
        run: bun run build

      - name: Create output directories
        run: mkdir -p test-results coverage/core coverage/shared coverage/server

      - name: Test core
        if: always()
        run: |
          cd packages/core
          bun test --reporter=junit --reporter-outfile=../../test-results/core.xml \
            --coverage --coverage-reporter=lcov --coverage-dir=../../coverage/core

      - name: Test shared
        if: always()
        run: |
          cd packages/shared
          bun test --reporter=junit --reporter-outfile=../../test-results/shared.xml \
            --coverage --coverage-reporter=lcov --coverage-dir=../../coverage/shared

      - name: Test server
        if: always()
        run: |
          cd packages/server
          bun test --reporter=junit --reporter-outfile=../../test-results/server.xml \
            --coverage --coverage-reporter=lcov --coverage-dir=../../coverage/server

      - name: Test Report
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Test Results
          path: test-results/*.xml
          reporter: java-junit

      - name: Generate Coverage Report
        if: always()
        run: |
          {
            echo "## Coverage Report"
            echo ""
            echo "| Package | Lines | Coverage |"
            echo "| --- | --- | --- |"
            for pkg in core shared server; do
              if [ -f "coverage/$pkg/lcov.info" ]; then
                LINES_FOUND=$(grep -c "^DA:" "coverage/$pkg/lcov.info" 2>/dev/null || echo "0")
                LINES_HIT=$(grep "^DA:" "coverage/$pkg/lcov.info" 2>/dev/null | grep -v ",0$" | wc -l | tr -d ' ')
                if [ "$LINES_FOUND" -gt 0 ]; then
                  PCT=$((LINES_HIT * 100 / LINES_FOUND))
                  echo "| **$pkg** | $LINES_HIT / $LINES_FOUND | ${PCT}% |"
                fi
              fi
            done
          } > coverage-report.md
          cat coverage-report.md

      - name: Add Coverage to PR
        uses: marocchino/sticky-pull-request-comment@v2
        if: github.event_name == 'pull_request'
        with:
          path: coverage-report.md

      - name: Upload to Codecov
        uses: codecov/codecov-action@v5
        if: always()
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage/core/lcov.info,coverage/shared/lcov.info,coverage/server/lcov.info
          fail_ci_if_error: false
